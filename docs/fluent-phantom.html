<!DOCTYPE html>

<html>
<head>
  <title>#</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="builder-grammar.html">
                builder-grammar.coffee
              </a>
            
              
              <a class="source" href="fluent-phantom.html">
                fluent-phantom.coffee
              </a>
            
              
              <a class="source" href="grammar.html">
                grammar.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1 id="-">#</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre>A fluent DSL <span class="hljs-keyword">for</span> scraping web content using [PhantomJS](<span class="hljs-attribute">http</span>:<span class="hljs-regexp">//</span>phantomjs.org/) 
<span class="hljs-keyword">and</span> the [PhantomJS bridge <span class="hljs-keyword">for</span> Node](<span class="hljs-attribute">https</span>:<span class="hljs-regexp">//gi</span>thub.com/sgentle/phantomjs-node).</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h1 id="-">#</h1>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>We require EventEmitter to be inherited by Request</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Emitter = <span class="hljs-built_in">require</span>(<span class="hljs-string">'events'</span>).EventEmitter</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>And we require our DSL grammar</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Grammar = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./builder-grammar'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>A simple helper to provide the time</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">now</span> = -&gt;</span>
    (<span class="hljs-keyword">new</span> Date).getTime()</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Classes are defined in a function to allow dependencies to be injected.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">binder</span> = <span class="hljs-params">(phantom)</span> -&gt;</span>
    phantom = <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> phantom == <span class="hljs-string">'object'</span> <span class="hljs-keyword">then</span> phantom <span class="hljs-keyword">else</span> <span class="hljs-built_in">require</span> <span class="hljs-string">'phantom'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>A fluent builder</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Builder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Grammar</span>.<span class="hljs-title">Sentence</span></span>

        <span class="hljs-attribute">constructor</span>:<span class="hljs-function"> -&gt;</span>
            <span class="hljs-keyword">super</span>()
            <span class="hljs-property">@properties</span> = 
                <span class="hljs-attribute">conditions</span>: []
                <span class="hljs-attribute">actions</span>: []
                <span class="hljs-attribute">errorHandlers</span>: []
                <span class="hljs-attribute">timeout</span>: <span class="hljs-literal">null</span>
                <span class="hljs-attribute">url</span>: <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Currying keeps access consistent - otherwise you’d have to use 
something like timeout.after(val) instead of timeout().after(val)
and timeout(val)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-attribute">timeout</span>: <span class="hljs-function"><span class="hljs-params">(val)</span> -&gt;</span> 
            obj = <span class="hljs-property">@_chunk</span> <span class="hljs-keyword">new</span> Grammar.Timeout @
            obj._push val
        
        <span class="hljs-attribute">forever</span>:<span class="hljs-function"> -&gt;</span> <span class="hljs-property">@timeout</span>(<span class="hljs-number">0</span>)

        <span class="hljs-attribute">extract</span>: <span class="hljs-function"><span class="hljs-params">(val)</span> -&gt;</span> 
            obj = <span class="hljs-property">@_chunk</span> <span class="hljs-keyword">new</span> Grammar.Extract @
            obj._push val

        <span class="hljs-attribute">select</span>: <span class="hljs-function"><span class="hljs-params">(val)</span> -&gt;</span> <span class="hljs-property">@extract</span> val

        <span class="hljs-attribute">when</span>: <span class="hljs-function"><span class="hljs-params">(val)</span> -&gt;</span>
            obj = <span class="hljs-property">@_chunk</span> <span class="hljs-keyword">new</span> Grammar.WaitFor @
            obj._push val

        <span class="hljs-attribute">wait</span>: <span class="hljs-function"><span class="hljs-params">(val)</span> -&gt;</span> <span class="hljs-property">@when</span> val

        <span class="hljs-attribute">from</span>: <span class="hljs-function"><span class="hljs-params">(val)</span> -&gt;</span>
            obj = <span class="hljs-property">@_chunk</span> <span class="hljs-keyword">new</span> Grammar.From @
            obj._push val

        <span class="hljs-attribute">url</span>: <span class="hljs-function"><span class="hljs-params">(val)</span> -&gt;</span> <span class="hljs-property">@from</span> val

        <span class="hljs-attribute">otherwise</span>: <span class="hljs-function"><span class="hljs-params">(val)</span> -&gt;</span>
            obj = <span class="hljs-property">@_chunk</span> <span class="hljs-keyword">new</span> Grammar.Otherwise @
            obj._push val

        <span class="hljs-attribute">evaluate</span>: <span class="hljs-function"><span class="hljs-params">(val)</span> -&gt;</span>
            obj = <span class="hljs-property">@_chunk</span> <span class="hljs-keyword">new</span> Grammar.Execute @
            obj._push val

        <span class="hljs-attribute">do</span>: <span class="hljs-function"><span class="hljs-params">(val)</span> -&gt;</span> <span class="hljs-property">@evaluate</span> val</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Conditional synonym: until(1000) should be interpreted as setting
the request timeout to 1s, but until(‘selector’) and until(-&gt;) should
be understood as synonymous with when().</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-attribute">until</span>: <span class="hljs-function"><span class="hljs-params">(arg)</span> -&gt;</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> arg <span class="hljs-keyword">is</span> <span class="hljs-string">'number'</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@timeout</span>(arg)
            <span class="hljs-keyword">else</span> <span class="hljs-property">@when</span>(arg)</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Allow crossover to an immediately previous Extract clause for 
extract(‘selector’).and(-&gt;).with(props)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-attribute">with</span>: <span class="hljs-function"><span class="hljs-params">(args...)</span> -&gt;</span>
            <span class="hljs-keyword">for</span> idx <span class="hljs-keyword">in</span> [<span class="hljs-property">@_chunks</span>.length - <span class="hljs-number">1</span> .. <span class="hljs-number">0</span>]
                <span class="hljs-keyword">if</span> <span class="hljs-property">@_chunks</span>[idx] <span class="hljs-keyword">instanceof</span> Grammar.Extract
                    <span class="hljs-property">@_chunks</span>[idx].<span class="hljs-reserved">with</span>(args)
                    <span class="hljs-keyword">return</span> @
            @</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Build a request, applying all changes described in the grammar.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-attribute">build</span>:<span class="hljs-function"> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Extract information provided through all chunks</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-property">@_mutate</span>()
            req = <span class="hljs-keyword">new</span> Request
            <span class="hljs-keyword">if</span> <span class="hljs-property">@properties</span>.timeout? <span class="hljs-keyword">and</span> <span class="hljs-property">@properties</span>.timeout &gt;= <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> req.timeout <span class="hljs-property">@properties</span>.timeout
            <span class="hljs-keyword">if</span> <span class="hljs-property">@properties</span>.url <span class="hljs-keyword">then</span> req.url <span class="hljs-property">@properties</span>.url

            req.condition(condition) <span class="hljs-keyword">for</span> condition <span class="hljs-keyword">in</span> <span class="hljs-property">@properties</span>.conditions
            <span class="hljs-keyword">for</span> callback <span class="hljs-keyword">in</span> <span class="hljs-property">@properties</span>.errorHandlers
                req.<span class="hljs-literal">on</span>(events.TIMEOUT, callback)
                req.<span class="hljs-literal">on</span>(events.REQUEST_FAILURE, callback)
            req.action(action) <span class="hljs-keyword">for</span> action <span class="hljs-keyword">in</span> <span class="hljs-property">@properties</span>.actions

            req</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Build and immediately execute a request</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-attribute">execute</span>: <span class="hljs-function"><span class="hljs-params">(url)</span> -&gt;</span>
            <span class="hljs-property">@from</span> url
            req = <span class="hljs-property">@build</span>()
            req.execute()
            req

        <span class="hljs-attribute">_terminated</span>:<span class="hljs-function"> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>After the first chunk has been applied, expand to allow joining
chunks with <code>and()</code></p>
<p>Not so sure I like this…</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> <span class="hljs-property">@and</span> <span class="hljs-keyword">is</span> <span class="hljs-string">'undefined'</span>
                <span class="hljs-property">@and</span> =<span class="hljs-function"> -&gt;</span> @</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Events that may be emitted by a Request</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    events =
        <span class="hljs-attribute">HALT</span>: <span class="hljs-string">'halted'</span>
        <span class="hljs-attribute">PHANTOM_CREATE</span>: <span class="hljs-string">'phantom-created'</span>
        <span class="hljs-attribute">PAGE_CREATE</span>: <span class="hljs-string">'page-created'</span>
        <span class="hljs-attribute">PAGE_OPEN</span>: <span class="hljs-string">'page-opened'</span>
        <span class="hljs-attribute">TIMEOUT</span>: <span class="hljs-string">'timeout'</span>
        <span class="hljs-attribute">REQUEST_FAILURE</span>: <span class="hljs-string">'failed'</span>
        <span class="hljs-attribute">READY</span>: <span class="hljs-string">'ready'</span>
        <span class="hljs-attribute">FINISH</span>: <span class="hljs-string">'finished'</span>
        <span class="hljs-attribute">CHECKING</span>: <span class="hljs-string">'checking'</span>
        <span class="hljs-attribute">CONSOLE</span>: <span class="hljs-string">'console'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>A request</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Request</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Private method to clean up open Phantom instances and notify listeners</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-function"><span class="hljs-title">end</span> = -&gt;</span>
            <span class="hljs-property">@emit</span> events.FINISH
            clearInterval <span class="hljs-property">@_interval</span>
            <span class="hljs-property">@_phantom</span>.exit()

        <span class="hljs-function"><span class="hljs-title">log</span> = <span class="hljs-params">(msg)</span> -&gt;</span>
            <span class="hljs-built_in">console</span>.log msg

        <span class="hljs-attribute">constructor</span>:<span class="hljs-function"> -&gt;</span>
            <span class="hljs-property">@_url</span> = <span class="hljs-string">''</span>
            <span class="hljs-property">@_conditions</span> = []
            <span class="hljs-property">@_actions</span> = []
            <span class="hljs-property">@_interval</span> = <span class="hljs-literal">null</span>
            <span class="hljs-property">@_phantom</span> = <span class="hljs-literal">null</span>
            <span class="hljs-property">@_page</span> = <span class="hljs-literal">null</span>
            <span class="hljs-property">@_timeout</span> = <span class="hljs-number">3000</span>
            <span class="hljs-property">@_bindConsole</span> = <span class="hljs-literal">false</span>
            <span class="hljs-property">@_debug</span> = <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Add a callback that must return true before emitting ready</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-attribute">condition</span>: <span class="hljs-function"><span class="hljs-params">(callback)</span> -&gt;</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> callback <span class="hljs-keyword">isnt</span> <span class="hljs-string">'function'</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">typeof</span> callback <span class="hljs-keyword">isnt</span> <span class="hljs-string">'object'</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">throw</span> Error <span class="hljs-string">"Invalid condition"</span>
            <span class="hljs-property">@_conditions</span>.push callback
            <span class="hljs-keyword">this</span>

        <span class="hljs-attribute">action</span>: <span class="hljs-function"><span class="hljs-params">(callback)</span> -&gt;</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> callback <span class="hljs-keyword">isnt</span> <span class="hljs-string">'function'</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">throw</span> Error <span class="hljs-string">"Invalid action"</span>
            <span class="hljs-property">@_actions</span>.push callback
            <span class="hljs-keyword">this</span></pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Set or get the timeout value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-attribute">timeout</span>: <span class="hljs-function"><span class="hljs-params">(value)</span> -&gt;</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> value == <span class="hljs-string">'number'</span> &amp;&amp; value &gt;= <span class="hljs-number">0</span>
                <span class="hljs-property">@_timeout</span> = value
                <span class="hljs-keyword">this</span>
            <span class="hljs-keyword">else</span>
                <span class="hljs-property">@_timeout</span></pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Toggle binding console.log to the PhantomJS instance’s console.log.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-attribute">console</span>: <span class="hljs-function"><span class="hljs-params">(bind)</span> -&gt;</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> bind <span class="hljs-keyword">is</span> <span class="hljs-string">'boolean'</span>
                <span class="hljs-property">@_bindConsole</span> = bind
                <span class="hljs-keyword">if</span> <span class="hljs-property">@_bindConsole</span>
                    <span class="hljs-property">@addListener</span> events.CONSOLE, log
                <span class="hljs-keyword">else</span>
                    <span class="hljs-property">@removeListener</span> events.CONSOLE, log
                @

            <span class="hljs-keyword">else</span>
                <span class="hljs-property">@_bindConsole</span></pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Enable or disable debugging</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-attribute">debug</span>: <span class="hljs-function"><span class="hljs-params">(isOn)</span> -&gt;</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> isOn <span class="hljs-keyword">is</span> <span class="hljs-string">'boolean'</span>
                <span class="hljs-property">@_debug</span> = isOn
                <span class="hljs-keyword">if</span> <span class="hljs-property">@_debug</span>
                    <span class="hljs-keyword">for</span> key, event <span class="hljs-keyword">of</span> events
                        <span class="hljs-keyword">do</span> <span class="hljs-function"><span class="hljs-params">(event)</span> -&gt;</span>
                            <span class="hljs-property">@addListener</span> event, <span class="hljs-built_in">console</span>.log event
                <span class="hljs-keyword">else</span>
                    <span class="hljs-keyword">for</span> key, event <span class="hljs-keyword">of</span> events
                        <span class="hljs-keyword">do</span> <span class="hljs-function"><span class="hljs-params">(event)</span> -&gt;</span>
                            <span class="hljs-property">@removeListener</span> event, <span class="hljs-built_in">console</span>.log event
                @

            <span class="hljs-keyword">else</span>
                <span class="hljs-property">@_debug</span></pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Set or get the URL</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-attribute">url</span>: <span class="hljs-function"><span class="hljs-params">(url)</span> -&gt;</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> url == <span class="hljs-string">'string'</span>
                <span class="hljs-property">@_url</span> = url
                <span class="hljs-keyword">this</span>
            <span class="hljs-keyword">else</span>
                <span class="hljs-property">@_url</span></pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Interrupt execution and end ASAP</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-attribute">halt</span>:<span class="hljs-function"> -&gt;</span>
            <span class="hljs-property">@emit</span> events.HALT
            end.call <span class="hljs-keyword">this</span></pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Execute the request</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-attribute">execute</span>: <span class="hljs-function"><span class="hljs-params">(url)</span> -&gt;</span>
            <span class="hljs-property">@url</span> url   <span class="hljs-comment"># Set the URL if it was provided</span>

            phantom.create <span class="hljs-function"><span class="hljs-params">(ph)</span> =&gt;</span>
                <span class="hljs-property">@_phantom</span> = ph
                <span class="hljs-property">@emit</span> events.PHANTOM_CREATE
                
                ph.createPage <span class="hljs-function"><span class="hljs-params">(page)</span> =&gt;</span>
                    <span class="hljs-property">@_page</span> = page
                    page.set<span class="hljs-function"><span class="hljs-params">(<span class="hljs-string">'onConsoleMessage'</span>, (msg) =&gt; <span class="hljs-property">@emit</span> events.CONSOLE, msg)</span>
                    @<span class="hljs-title">emit</span> <span class="hljs-title">events</span>.<span class="hljs-title">PAGE_CREATE</span>

                    <span class="hljs-title">page</span>.<span class="hljs-title">open</span> @<span class="hljs-title">_url</span>, <span class="hljs-params">(status)</span> =&gt;</span>
                        <span class="hljs-keyword">if</span> (status != <span class="hljs-string">'success'</span>)        <span class="hljs-comment"># Request failed</span>
                            <span class="hljs-property">@emit</span> events.REQUEST_FAILURE
                            end.call <span class="hljs-keyword">this</span>

                        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@_conditions</span>.length     <span class="hljs-comment"># Request succeeded, but we have to verify the DOM</span>
                            start = now()</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>This function is called over and over until all conditions 
have been satisfied or we run out of time.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            <span class="hljs-function"><span class="hljs-title">tick</span> = =&gt;</span>
                                <span class="hljs-property">@emit</span> events.CHECKING</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Timeout</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                <span class="hljs-keyword">if</span> <span class="hljs-property">@_timeout</span> &gt; <span class="hljs-number">0</span> &amp;&amp; now() - start &gt; <span class="hljs-property">@_timeout</span>
                                    <span class="hljs-property">@emit</span> events.TIMEOUT, page
                                    end.call <span class="hljs-keyword">this</span></pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Check all conditions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                <span class="hljs-keyword">else</span>
                                    isReady = <span class="hljs-literal">true</span>
                                    tests = <span class="hljs-property">@_conditions</span>[..]

                                    <span class="hljs-function"><span class="hljs-title">check</span> = <span class="hljs-params">(condition)</span> =&gt;</span>
                                        <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> condition <span class="hljs-keyword">is</span> <span class="hljs-string">'function'</span>
                                            test = condition
                                            args = <span class="hljs-literal">null</span>

                                        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> condition <span class="hljs-keyword">is</span> <span class="hljs-string">'object'</span>
                                            [args, test] = condition

                                        <span class="hljs-function"><span class="hljs-title">handler</span> = <span class="hljs-params">(result)</span> =&gt;</span>
                                            isReady = isReady &amp; result
                                            <span class="hljs-keyword">if</span> isReady
                                                <span class="hljs-keyword">if</span> tests.length
                                                    check tests.pop()
                                                <span class="hljs-keyword">else</span>
                                                    action(page) <span class="hljs-keyword">for</span> action <span class="hljs-keyword">in</span> <span class="hljs-property">@_actions</span>
                                                    <span class="hljs-property">@emit</span> events.READY, page
                                                    end.call <span class="hljs-keyword">this</span>
                                        
                                        page.evaluate test, handler, args

                                    check tests.pop()

                            <span class="hljs-property">@_interval</span> = setInterval tick, <span class="hljs-number">250</span>

                        <span class="hljs-keyword">else</span>                            <span class="hljs-comment"># Request succeeded and no verifications necessary - proceed!</span>
                            <span class="hljs-property">@emit</span> events.READY, page
                            action(page) <span class="hljs-keyword">for</span> action <span class="hljs-keyword">in</span> <span class="hljs-property">@_actions</span>
                            end.call <span class="hljs-keyword">this</span></pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Ensure that Request can emit events</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Request.prototype.__proto__ = Emitter.prototype</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Export bound classes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-built_in">exports</span> =
        <span class="hljs-string">"Request"</span>: Request
        <span class="hljs-string">"Builder"</span>: Builder
        <span class="hljs-string">"create"</span>:<span class="hljs-function"> -&gt;</span> <span class="hljs-keyword">new</span> Builder
        

<span class="hljs-built_in">module</span>.<span class="hljs-built_in">exports</span> = binder()
<span class="hljs-built_in">module</span>.<span class="hljs-built_in">exports</span>.inject = binder</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
